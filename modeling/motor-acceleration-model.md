Now, we face a common challenge: modeling a DC motor system when its detailed datasheet parameters (like armature resistance, inductance, torque constant $K_t$, back-EMF constant $K_b$) are unavailable. We'll aim for an empirical model based on measurable quantities.

The system is the motor-wheel pair.
* **Input:** Duty Cycle ($D$) of the PWM signal (a dimensionless value, $0 \le D \le 1$).
* **Output:** Wheel's angular acceleration relative to the motor shaft ($\ddot{\phi}$).
* **Knowns:** PWM frequency $f$, PWM supply voltage $V$, wheel moment of inertia $I_{w,cm}$ (calculated in the previous model).
    $I_{w,cm} = \frac{1}{8} M_{wheel} (D_{wheel\_out}^2 + D_{wheel\_in}^2)$
* **Measurable:** Motor shaft speed $\dot{\phi}$ (via encoder), and by extension $\ddot{\phi}$ (by numerical differentiation of $\dot{\phi}$). The robot's body angle $\theta$ and its derivatives $\dot{\theta}, \ddot{\theta}$ might also be measurable depending on other sensors.

## Theoretical Basis (Simplified DC Motor Model)

1.  **Effective Voltage:** The PWM signal provides an average voltage to the motor:
    $V_{eff} = D \cdot V$
    This assumes the PWM frequency $f$ is high enough for the motor's inductance to smooth the current.

2.  **Motor Torque:** The torque $\tau_m$ generated by a DC motor can be approximated by a linear model:
    $\tau_m \approx c_1 V_{eff} - c_2 \dot{\phi}$
    $\tau_m \approx (c_1 V) D - c_2 \dot{\phi}$
    Where:
    * $\dot{\phi}$ is the angular speed of the motor shaft relative to the motor casing.
    * $c_1$ is a constant related to motor's torque constant and armature resistance.
    * $c_2$ is a constant related to motor's torque constant, back-EMF constant, and armature resistance (it represents speed-dependent damping, primarily from back-EMF).

    Let $K_D = c_1 V$ and $K_{\omega} = c_2$. Then:
    $\tau_m \approx K_D D - K_{\omega} \dot{\phi}$
    $K_D$ represents how effectively the duty cycle generates torque (at zero speed). $K_{\omega}$ represents how much torque is lost per unit of angular speed.

3.  **Load Dynamics:** The motor torque $\tau_m$ is applied to the wheel. This torque causes the absolute angular acceleration of the wheel ($\ddot{\theta}_w = \ddot{\theta} + \ddot{\phi}$), where $\ddot{\theta}$ is the angular acceleration of the robot body (motor casing).
    From the previous derivation (Equation 2):
    $\tau_m = I_{w,cm} (\ddot{\theta} + \ddot{\phi})$

## Combining Motor Model and Load Dynamics

Equating the two expressions for $\tau_m$:
$K_D D - K_{\omega} \dot{\phi} = I_{w,cm} (\ddot{\theta} + \ddot{\phi})$

We want the output to be $\ddot{\phi}$:
$I_{w,cm} \ddot{\phi} = K_D D - K_{\omega} \dot{\phi} - I_{w,cm} \ddot{\theta}$
$$\ddot{\phi}(t) = \frac{K_D}{I_{w,cm}} D(t) - \frac{K_{\omega}}{I_{w,cm}} \dot{\phi}(t) - \ddot{\theta}(t)$$

This is the model structure. The parameters $K_D$ and $K_{\omega}$ are unknown and need to be determined experimentally. The term $\ddot{\theta}(t)$ represents the coupling from the main robot body's motion; it's how the body's acceleration affects the wheel's acceleration relative to the body for a given motor effort.

## Experimental Parameter Identification

To find $K_D$ and $K_{\omega}$, we need to conduct experiments. Ideally, these experiments should isolate the motor-wheel dynamics as much as possible by constraining the robot body's motion (i.e., making $\theta, \dot{\theta}, \ddot{\theta}$ all zero).

**Setup for Experiments:**
Securely fix the robot body so it cannot tilt ($\theta(t)=0 \implies \dot{\theta}(t)=0, \ddot{\theta}(t)=0$).
In this fixed setup, the model simplifies to:
$\ddot{\phi}(t) = \frac{K_D}{I_{w,cm}} D(t) - \frac{K_{\omega}}{I_{w,cm}} \dot{\phi}(t)$

**Experiment 1: Stall Torque Characteristics (to find $K_D$)**
This aims to find the relationship between duty cycle and torque at or near zero speed.
1.  With the robot body fixed and the wheel initially at rest ($\dot{\phi} \approx 0$).
2.  Apply a small, constant duty cycle $D$.
3.  Measure the initial angular acceleration $\ddot{\phi}_{init}$ of the wheel immediately after applying the PWM signal (before $\dot{\phi}$ becomes significant). This requires high-frequency sampling of the encoder data and numerical differentiation.
4.  Under these conditions ($\dot{\phi} \approx 0, \ddot{\theta}=0$):
    $\ddot{\phi}_{init} \approx \frac{K_D}{I_{w,cm}} D$
5.  Repeat for several different values of $D$.
6.  Plot $\ddot{\phi}_{init}$ (y-axis) versus $D$ (x-axis). This should yield a straight line.
7.  The slope of this line is $m_1 = K_D/I_{w,cm}$.
8.  Since $I_{w,cm}$ is known, calculate $K_D = m_1 \cdot I_{w,cm}$.

**Experiment 2: Steady-State Speed Characteristics (to find $K_{\omega}$)**
This aims to find the relationship between duty cycle and speed when the wheel is not accelerating.
1.  With the robot body fixed ($\ddot{\theta}=0$).
2.  Apply a constant duty cycle $D$.
3.  Allow the wheel to reach a steady-state angular velocity $\dot{\phi}_{ss}$. At steady state, $\ddot{\phi}=0$.
4.  Under these conditions ($\ddot{\phi}=0, \ddot{\theta}=0$):
    $0 = \frac{K_D}{I_{w,cm}} D - \frac{K_{\omega}}{I_{w,cm}} \dot{\phi}_{ss}$
    $K_D D = K_{\omega} \dot{\phi}_{ss}$
    $\dot{\phi}_{ss} = \frac{K_D}{K_{\omega}} D$
5.  Repeat for several different values of $D$, recording the corresponding $\dot{\phi}_{ss}$.
6.  Plot $\dot{\phi}_{ss}$ (y-axis) versus $D$ (x-axis). This should also yield a straight line.
7.  The slope of this line is $m_2 = K_D/K_{\omega}$.
8.  Since $K_D$ is known from Experiment 1, calculate $K_{\omega} = K_D / m_2$.
    Alternatively, plot $K_D D$ (y-axis, using $K_D$ from Exp.1) vs $\dot{\phi}_{ss}$ (x-axis). The slope is directly $K_{\omega}$.

## Final Motor-Wheel Model

The model for the motor-wheel pair, with input $D(t)$ and output $\ddot{\phi}(t)$, is:

$$\ddot{\phi}(t) = \left(\frac{K_D}{I_{w,cm}}\right) D(t) - \left(\frac{K_{\omega}}{I_{w,cm}}\right) \dot{\phi}(t) - \ddot{\theta}(t)$$

Where:
* $D(t)$ is the PWM duty cycle (input).
* $\dot{\phi}(t)$ is the wheel's angular velocity relative to the motor shaft (a state variable, measurable).
* $\ddot{\theta}(t)$ is the angular acceleration of the robot body (a coupling term from the rest of the system). If the model is strictly for the motor-wheel pair isolated from body motion effects (e.g., for test bench characterization), this term might be considered zero. However, in the context of the self-balancing robot, it's present.
* $I_{w,cm}$ is the moment of inertia of the wheel about its axis.
* $K_D$ and $K_{\omega}$ are constants determined experimentally as described above.

**Assumptions and Notes:**
* The linear motor model $\tau_m = K_D D - K_{\omega} \dot{\phi}$ is an approximation. Real motors have nonlinearities like stiction, friction, and magnetic saturation.
* The effectiveness of $V_{eff} = D \cdot V$ depends on the PWM frequency being sufficiently high relative to the motor's electrical time constant.
* Temperature can affect motor parameters (especially winding resistance, which influences $K_D$ and $K_{\omega}$). The experiments should be done at typical operating temperatures.
* Numerical differentiation to get $\ddot{\phi}$ from $\dot{\phi}$ (which itself might be from position $\phi$) can be noisy. Filtering or careful numerical methods will be needed.

This model provides a practical way to relate PWM input to the wheel's relative acceleration, incorporating key measurable effects and known mechanical properties, while abstracting away detailed internal motor electrodynamics.
